<ion-header>
  <app-header titulo="Gesti√≥n de Historial M√©dico"></app-header>
</ion-header>

<ion-content class="ion-padding">
  <!-- 1) Segment -->
  <ion-segment [(ngModel)]="vista">
    <ion-segment-button value="gestion">Gesti√≥n</ion-segment-button>
    <ion-segment-button value="entrada" [disabled]="!entradaDetalle">Entrada</ion-segment-button>
  </ion-segment>

  <!-- 2) VISTA GESTI√ìN -->
  <ng-container *ngIf="vista === 'gestion'">
    <!-- Buscar cliente -->
    <ion-searchbar
      [(ngModel)]="busquedaCliente"
      (ionInput)="buscarClientes()"
      placeholder="Buscar cliente"
      debounce="300"
    ></ion-searchbar>

    <!-- Lista de clientes -->
    <ion-list>
      <ion-item *ngFor="let c of clientesFiltrados" (click)="seleccionarCliente(c)">
        {{ c.nombre }} {{ c.apellido }}
      </ion-item>
    </ion-list>

    <!-- Selector de mascota -->
    <ion-item *ngIf="clienteSeleccionado">
      <ion-label>Selecciona la mascota</ion-label>
      <ion-select
        [(ngModel)]="mascotaSeleccionada"
        (ionChange)="cargarHistorial()"
        placeholder="Elige mascota"
      >
        <ion-select-option *ngFor="let m of mascotasDelCliente" [value]="m">
          {{ m.nombre }}
        </ion-select-option>
      </ion-select>
    </ion-item>

    <!-- Filtro por mes -->
    <ion-item *ngIf="historialMedico?.entradas?.length">
      <ion-label>Filtrar mes</ion-label>
      <ion-select
        [(ngModel)]="mesSeleccionado"
        (ionChange)="filtrarPorMes()"
        placeholder="Todos"
      >
        <ion-select-option value="">Todos</ion-select-option>
        <ion-select-option *ngFor="let mes of mesesDisponibles" [value]="mes">
          {{ mes < 10 ? '0' + mes : mes }}
        </ion-select-option>
      </ion-select>
    </ion-item>

    <!-- Lista de entradas filtradas -->
    <ion-list *ngIf="historialMedico && mascotaSeleccionada">
      <ion-item
        *ngFor="let e of entradasFiltradas"
        button
        (click)="abrirDetalleEntrada(e)"
      >
        <ion-label>
          <h2>
            {{ e.fecha | date:'dd/MM/yy' }} ‚Äî {{ e.fecha | date:'HH:mm' }}
          </h2>
          <p>üêæ {{ mascotaSeleccionada.nombre }}</p>
        </ion-label>
        <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
      </ion-item>
    </ion-list>

    <!-- Bot√≥n para agregar nueva entrada -->
    <ion-button
      
      color="primary"
      *ngIf="mascotaSeleccionada"
      (click)="abrirFormularioEntrada()"
    >
      Agregar nueva entrada
    </ion-button>
  </ng-container>

  <!-- 3) VISTA DETALLE DE ENTRADA -->
  <ng-container *ngIf="vista === 'entrada' && entradaDetalle">
    <ion-card>
      <ion-card-header>
        <!-- Flex container para t√≠tulo + bot√≥n -->
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <ion-card-title>Detalle de Entrada</ion-card-title>
          <ion-button
            *ngIf="!editMode"
            fill="clear"
            size="small"
            (click)="enableEdit()"
          >
            <ion-icon slot="start" name="create-outline"></ion-icon>
            Editar
          </ion-button>
        </div>
        <ion-card-subtitle>
          Mascota: {{ entradaDetalle.mascota.nombre }}<br/>
          Cliente:
          {{ entradaDetalle.mascota.cliente.nombre }}
          {{ entradaDetalle.mascota.cliente.apellido }}
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <!-- Fecha -->
        <ion-item lines="none">
          
          <ion-datetime
          
            *ngIf="editMode"
            display-format="dd/MM/yy HH:mm"
            [(ngModel)]="editableEntrada.fecha"
          ><ion-label>Fecha Entrada:</ion-label></ion-datetime>
          <span *ngIf="!editMode">
            {{ entradaDetalle.fecha | date:'dd/MM/yy HH:mm' }}
          </span>
        </ion-item>

        <!-- Diagn√≥sticos -->
        <ion-item lines="none">
          <ion-label position="stacked"><strong>Diagn√≥sticos:</strong></ion-label>
          <ng-container *ngIf="!editMode">
            <p>{{ entradaDetalle.diagnosticos || '‚Äî' }}</p>
          </ng-container>
          <ion-textarea
            *ngIf="editMode"
            auto-grow
            [(ngModel)]="editableEntrada.diagnosticos"
          ></ion-textarea>
        </ion-item>

        <!-- Tratamientos -->
        <ion-item lines="none">
          <ion-label position="stacked"><strong>Tratamientos:</strong></ion-label>
          <ng-container *ngIf="!editMode">
            <p>{{ entradaDetalle.tratamientos || '‚Äî' }}</p>
          </ng-container>
          <ion-textarea
            *ngIf="editMode"
            auto-grow
            [(ngModel)]="editableEntrada.tratamientos"
          ></ion-textarea>
        </ion-item>

        <!-- Observaciones -->
        <ion-item lines="none">
          <ion-label position="stacked"><strong>Observaciones:</strong></ion-label>
          <ng-container *ngIf="!editMode">
            <p>{{ entradaDetalle.observaciones || '‚Äî' }}</p>
          </ng-container>
          <ion-textarea
            *ngIf="editMode"
            auto-grow
            [(ngModel)]="editableEntrada.observaciones"
          ></ion-textarea>
        </ion-item>

        <!-- Datos de la cita asociada (solo lectura) -->
        <ion-item lines="none">
          <ion-label>
            <strong>Cita asociada:</strong><br/>
            Fecha: {{ entradaDetalle.cita.fechaHora | date:'dd/MM/yy HH:mm' }}<br/>
            Motivo: {{ entradaDetalle.cita.motivo }}<br/>
            Estado: {{ entradaDetalle.cita.estado }}
          </ion-label>
        </ion-item>

        <!-- Botones -->
        <div *ngIf="!editMode">
          <ion-button  (click)="vista='gestion'">
            ‚Üê Volver a Gesti√≥n
          </ion-button>
        </div>
        <div *ngIf="editMode">
          <ion-button  color="warning" (click)="cancelEdit()">
            Cancelar
          </ion-button>
          <ion-button  color="success" (click)="saveEdit()">
            Guardar Cambios
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </ng-container>
</ion-content>
